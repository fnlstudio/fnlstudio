<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Feedback - FNL Studio</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      color: #e2e8f0;
      text-align: center;
      padding: 20px;
      margin: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .logo img {
      width: 200px;
      height: auto;
      margin-bottom: 30px;
      filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
    }
    h1 { font-size: 1.5em; margin: 15px 0; color: #f1f5f9; font-weight: 600; }
    .feedback-form {
      background-color: #1e293b;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      max-width: 500px;
      width: 90%;
      margin-bottom: 20px;
    }
    .feedback-form textarea {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      border: none;
      border-radius: 10px;
      background-color: #2d3b4e;
      color: #e2e8f0;
      resize: vertical;
    }
    .feedback-form button {
      background-color: #10b981;
      padding: 10px 20px;
      border: none;
      border-radius: 10px;
      color: white;
      cursor: pointer;
      font-weight: 600;
      margin-right: 10px;
      transition: background-color 0.3s, transform 0.2s;
    }
    .feedback-form button:hover { background-color: #059669; transform: translateY(-2px); }
    .feedback-section {
      margin: 20px 0;
    }
    .feedback-item {
      background-color: #1e293b;
      padding: 15px;
      border-radius: 15px;
      margin: 15px 0;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      text-align: left;
      position: relative;
    }
    .feedback-item .actions {
      margin-top: 10px;
    }
    .feedback-item button {
      background-color: #4a5b6f;
      padding: 5px 10px;
      border: none;
      border-radius: 5px;
      color: #e2e8f0;
      cursor: pointer;
      font-weight: 600;
      margin-right: 5px;
      transition: background-color 0.3s;
    }
    .feedback-item button:hover { background-color: #3a4b5f; }
    .back-button {
      background-color: #4a5b6f;
      padding: 12px 30px;
      border: none;
      border-radius: 10px;
      color: #e2e8f0;
      cursor: pointer;
      font-weight: 600;
      margin-top: 10px;
      transition: background-color 0.3s, transform 0.2s;
    }
    .back-button:hover { background-color: #3a4b5f; transform: translateY(-2px); }
    .footer {
      margin-top: auto;
      padding: 20px;
      background-color: #0f172a;
      width: 100%;
      text-align: center;
      border-top: 1px solid #2d3b4e;
    }
    .error-message { color: #ef4444; margin-top: 10px; }
  </style>
</head>
<body>
  <div class="logo">
    <img src="https://i.postimg.cc/kX2rSgJw/20250414-095948.png" alt="FNL Studio Logo" />
  </div>
  <h1>Feedback</h1>
  <div class="feedback-form">
    <textarea id="feedbackText" rows="4" placeholder="Write your feedback..." required></textarea>
    <button onclick="submitFeedback()">Submit</button>
  </div>
  <div class="feedback-section" id="feedbackSection">
    <!-- Feedback will be populated by JavaScript -->
  </div>
  <button class="back-button" onclick="window.location.href='index.html'">Back</button>
  <div class="footer">
    <h3>About Us</h3>
    <p>Welcome to FNL Studio – a creative collaboration between Light Editz and Flash Editz. We're passionate about visual storytelling and dedicated to providing high-quality, professional-grade presets for photo and video editors. Whether you're just starting out or you're a seasoned creator, our presets are crafted to give your content a unique, polished look with just a few clicks.</p>
    <h3>Copyright ©</h3>
    <p>© 2025 FNL Studio. All rights reserved. All content on this website, including presets, visuals, and text, is the intellectual property of FNL Studio and is protected by copyright laws. Any unauthorized use, reproduction, or distribution of our materials is strictly prohibited.</p>
  </div>
  <div id="errorMessage" class="error-message"></div>

  <script>
    const BIN_ID = "67fccb0b8960c979a584b5d5";
    const MASTER_KEY = "$2a$10$PlYW4zt8k/Be46UjnPgRSex64CZn7Sk7ifMW09AgYaT1.jS2pwjnO";
    const API_URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;
    const feedbackSection = document.getElementById("feedbackSection");
    let currentUser = localStorage.getItem("currentUser") || null;

    async function loadFeedback() {
      try {
        const response = await fetch(API_URL + "/latest", {
          headers: { "X-Master-Key": MASTER_KEY }
        });
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const data = await response.json();
        const feedbacks = data.record.feedbacks || [];
        feedbackSection.innerHTML = feedbacks.map(feedback => createFeedbackElement(feedback)).join("");
      } catch (error) {
        console.error("Error loading feedback:", error);
        feedbackSection.innerHTML = "<p>Error loading feedback. Contact admin.</p>";
      }
    }

    function createFeedbackElement(feedback) {
      const isOwner = currentUser && feedback.email === JSON.parse(currentUser).email;
      return `
        <div class="feedback-item" data-id="${feedback.timestamp}">
          <p>${feedback.text} - ${new Date(feedback.timestamp).toLocaleDateString()}</p>
          <div class="actions">
            <button onclick="toggleLike('${feedback.timestamp}')">${feedback.likes || 0} Like</button>
            <button onclick="toggleDislike('${feedback.timestamp}')">${feedback.dislikes || 0} Dislike</button>
            <button onclick="showReply('${feedback.timestamp}')">Reply</button>
            ${isOwner ? `<button onclick="editFeedback('${feedback.timestamp}')">Edit</button>` : ''}
            ${isOwner ? `<button onclick="deleteFeedback('${feedback.timestamp}')">Delete</button>` : ''}
          </div>
          <div id="reply-${feedback.timestamp}" style="display:none;">
            <textarea id="replyText-${feedback.timestamp}" rows="2" placeholder="Write a reply..."></textarea>
            <button onclick="submitReply('${feedback.timestamp}')">Submit Reply</button>
          </div>
        </div>
      `;
    }

    async function submitFeedback() {
      const text = document.getElementById("feedbackText").value.trim();
      if (!text || !currentUser) return;
      const feedback = { text, email: JSON.parse(currentUser).email, timestamp: new Date().toISOString(), likes: 0, dislikes: 0, replies: [] };
      try {
        const response = await fetch(API_URL + "/latest", { headers: { "X-Master-Key": MASTER_KEY } });
        const data = await response.json();
        const feedbacks = data.record.feedbacks || [];
        feedbacks.push(feedback);
        await fetch(API_URL, {
          method: "PUT",
          headers: { "X-Master-Key": MASTER_KEY, "Content-Type": "application/json" },
          body: JSON.stringify({ ...data.record, feedbacks })
        });
        document.getElementById("feedbackText").value = "";
        loadFeedback();
      } catch (error) {
        console.error("Error submitting feedback:", error);
      }
    }

    async function toggleLike(timestamp) {
      try {
        const response = await fetch(API_URL + "/latest", { headers: { "X-Master-Key": MASTER_KEY } });
        const data = await response.json();
        const feedbacks = data.record.feedbacks.map(f => {
          if (f.timestamp === timestamp) f.likes = (f.likes || 0) + 1;
          return f;
        });
        await fetch(API_URL, {
          method: "PUT",
          headers: { "X-Master-Key": MASTER_KEY, "Content-Type": "application/json" },
          body: JSON.stringify({ ...data.record, feedbacks })
        });
        loadFeedback();
      } catch (error) { console.error("Error liking feedback:", error); }
    }

    async function toggleDislike(timestamp) {
      try {
        const response = await fetch(API_URL + "/latest", { headers: { "X-Master-Key": MASTER_KEY } });
        const data = await response.json();
        const feedbacks = data.record.feedbacks.map(f => {
          if (f.timestamp === timestamp) f.dislikes = (f.dislikes || 0) + 1;
          return f;
        });
        await fetch(API_URL, {
          method: "PUT",
          headers: { "X-Master-Key": MASTER_KEY, "Content-Type": "application/json" },
          body: JSON.stringify({ ...data.record, feedbacks })
        });
        loadFeedback();
      } catch (error) { console.error("Error disliking feedback:", error); }
    }

    function showReply(timestamp) {
      document.getElementById(`reply-${timestamp}`).style.display = "block";
    }

    async function submitReply(timestamp) {
      const replyText = document.getElementById(`replyText-${timestamp}`).value.trim();
      if (!replyText) return;
      try {
        const response = await fetch(API_URL + "/latest", { headers: { "X-Master-Key": MASTER_KEY } });
        const data = await response.json();
        const feedbacks = data.record.feedbacks.map(f => {
          if (f.timestamp === timestamp) f.replies = f.replies || []; f.replies.push({ text: replyText, timestamp: new Date().toISOString() });
          return f;
        });
        await fetch(API_URL, {
          method: "PUT",
          headers: { "X-Master-Key": MASTER_KEY, "Content-Type": "application/json" },
          body: JSON.stringify({ ...data.record, feedbacks })
        });
        document.getElementById(`replyText-${timestamp}`).value = "";
        document.getElementById(`reply-${timestamp}`).style.display = "none";
        loadFeedback();
      } catch (error) { console.error("Error submitting reply:", error); }
    }

    async function editFeedback(timestamp) {
      const newText = prompt("Edit your feedback:", document.querySelector(`[data-id="${timestamp}"] p`).textContent.split(" - ")[0]);
      if (!newText) return;
      try {
        const response = await fetch(API_URL + "/latest", { headers: { "X-Master-Key": MASTER_KEY } });
        const data = await response.json();
        const feedbacks = data.record.feedbacks.map(f => {
          if (f.timestamp === timestamp) f.text = newText;
          return f;
        });
        await fetch(API_URL, {
          method: "PUT",
          headers: { "X-Master-Key": MASTER_KEY, "Content-Type": "application/json" },
          body: JSON.stringify({ ...data.record, feedbacks })
        });
        loadFeedback();
      } catch (error) { console.error("Error editing feedback:", error); }
    }

    async function deleteFeedback(timestamp) {
      if (!confirm("Are you sure you want to delete this feedback?")) return;
      try {
        const response = await fetch(API_URL + "/latest", { headers: { "X-Master-Key": MASTER_KEY } });
        const data = await response.json();
        const feedbacks = data.record.feedbacks.filter(f => f.timestamp !== timestamp);
        await fetch(API_URL, {
          method: "PUT",
          headers: { "X-Master-Key": MASTER_KEY, "Content-Type": "application/json" },
          body: JSON.stringify({ ...data.record, feedbacks })
        });
        loadFeedback();
      } catch (error) { console.error("Error deleting feedback:", error); }
    }

    // Set current user from login details
    window.onload = async () => {
      const response = await fetch(API_URL + "/latest", { headers: { "X-Master-Key": MASTER_KEY } });
      const data = await response.json();
      const loginDetails = data.record.login_details || [];
      if (loginDetails.length > 0) currentUser = JSON.stringify(loginDetails[loginDetails.length - 1]);
      loadFeedback();
    };
  </script>
</body>
</html>
